using System.Collections;
using System.Collections.Generic;
using Cinemachine;
using UnityEngine;

public class HitInvulnerability : MonoBehaviour
{
    bool _isInvulnerable = false;
    PlayerMovement playerMovement;
    int currentHealth;
    private float timeBetweenDmg;
    private float startTimeBetweenDmg;

    [SerializeField]
    private float InvulnerableTimer;

    [SerializeField]
    private float ShakeForce;

    // Start is called before the first frame update
    private SpriteRenderer playerSprite;

    [SerializeField]
    private CinemachineImpulseSource impulseSource;

    void Start()
    {
        playerMovement = GetComponent<PlayerMovement>();
        currentHealth = playerMovement.currentHealth;
        playerSprite = GetComponent<SpriteRenderer>();
    }

    // Update is called once per frame
    void Update() { }

    public void TryTakeDamage(int damage)
    {
        if (_isInvulnerable)
            return;
        else
        {
            StartCoroutine(StartInvulnerabilityTimer(damage));
        }
    }

    IEnumerator StartInvulnerabilityTimer(int damage)
    {
        TakeDamage(damage);
        _isInvulnerable = true;
        Color playerSpriteColor = playerSprite.color;
        playerSpriteColor.a = 0.5f;
        playerSprite.color = playerSpriteColor;
        gameObject.layer = LayerMask.NameToLayer("PlayerInvulnerable");
        yield return new WaitForSeconds(InvulnerableTimer);
        gameObject.layer = LayerMask.NameToLayer("Player");
        playerSpriteColor.a = 1;
        playerSprite.color = playerSpriteColor;
        _isInvulnerable = false;
    }

    private void TakeDamage(int damage)
    {
        CameraShakeManager.instance.CameraShake(impulseSource, ShakeForce);
        playerMovement.UpdateHealth(-damage);
    }
}
